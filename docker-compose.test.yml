services:
  keycloak:
    image: ghcr.io/aivot-digital/keycloak-egov-plugins:26.2.4.1
    restart: always
    command: [ 'start-dev' ]
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_HTTP_ENABLED: true
      KC_HTTP_PORT: 8080
      KC_HOSTNAME: http://localhost:8080
      KC_HOSTNAME_BACKCHANNEL_DYNAMIC: false
      KC_FEATURES: transient-users,update-email,hostname:v2
    ports:
      - "8080:8080"

  keycloak-setup:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - keycloak
    restart: on-failure
    environment:
      KEYCLOAK_URL: "http://keycloak:8080"
      KEYCLOAK_USER: "admin"
      KEYCLOAK_PASSWORD: "admin"
      KEYCLOAK_AVAILABILITYCHECK_ENABLED: true
      KEYCLOAK_AVAILABILITYCHECK_TIMEOUT: "120s"
      LOGGING_LEVEL_HTTP: "DEBUG"

      SMTP_HOST: "smtp.example.com"
      SMTP_PORT: "587"
      SMTP_USERNAME: "test"
      SMTP_PASSWORD: "test"
      SMTP_FROM: "test"
      SMTP_FROM_DISPLAY: "Mail Test"
      HOSTNAME: "http://localhost:8080"
      BACKEND_CLIENT_SECRET: "my-super-secret-key"
